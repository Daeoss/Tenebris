<!DOCTYPE html>
<html>
<head>
    <script src="/Server/node_modules/phaser/dist/phaser-arcade-physics.js"></script>
    <script src="/Server/node_modules/phaser/dist/phaser.js"></script>
</head>
<body>

    <script type="module">
        //randomize enemy creation
        import Enemy from '/Scripts/Enemy.js';
        import Player from '/Scripts/Player.js';
        import PowerUpsManager from '/Scripts/PowerUpsManager.js';
        import SpellManager from '/Scripts/SpellManager.js';
        import * as Setup from '/Scripts/Setup.js';
        import * as EnemyManager from '/Scripts/EnemyManager.js';
        import * as PowerUpEffects from '/Scripts/PowerUpEffects.js';

        var cam, background, cursors;

        class Main extends Phaser.Scene
        {
            static BOUNDS_X = 2560;
            static BOUNDS_Y = 1440;

            constructor() {
                super();
                this.score = 0;
                this.currentWaveIndex = 0;

                this.player = null;
                this.enemiesGroup = null;
                this.powerUpsGroup = null;
                this.wand = null;
                this.spells = null;
                this.spellManager = null;
                this.powerUpsManager = null;
                this.scoreText = null;
                this.grounds = null;
                this.platforms = null;
                this.isGameOver = false;
                this.leftMouseJustDown = false;
                this.rightMouseJustDown = false;
                this.spellsStorage = [];
                this.spellHolders = {
                    0: {x:375,y:50}, 
                    1: {x:450,y:50},
                    // holder1: {x:325,y:50}, 
                    // holder2: {x:400,y:50},
                    // holder3: {x:475,y:50},
                };
                this.waves  = [
                    {
                        title:'wave1',
                        time: 1000,
                        enemies: [
                            { type: 'flying', count:100, interval: 200 }
                        ],
                    },
                    {
                        title:'wave2', 
                        time: 5000,
                        enemies: [
                            { type: 'flying', count:1, interval: 500 }
                        ],
                    },
                    {
                        title:'wave3', 
                        time: 25000,
                        enemies: [
                            {  type: 'flying', count:1, interval: 100 }
                        ],
                    },
                ]
                
            }
            preload ()
            {
                this.load.image('sky', 'Assets/Media/Finished/sky.png');
                this.load.image('ground', 'Assets/Media/Finished/platform.png');
                this.load.image('star', 'Assets/Media/Finished/star.png');
                this.load.image('bomb', 'Assets/Media/Finished/bomb.png');
                this.load.image('shadow', 'Assets/Media/Finished/Shadow.png');
                this.load.image('flying-shadow', 'Assets/Media/Finished/FlyingShadow.png');
                this.load.image('wand', 'Assets/Media/Finished/wand.png');
                this.load.image('fire', 'Assets/Media/Finished/fire.png');
                this.load.image('fireUI', 'Assets/Media/Finished/fireUI.png');
                this.load.image('waterUI', 'Assets/Media/Finished/waterUI.png');
                this.load.image('airUI', 'Assets/Media/Finished/airUI.png');
                this.load.image('earthUI', 'Assets/Media/Finished/earthUI.png');
                this.load.image('spell-holder', 'Assets/Media/Finished/spell-holder.png');
                this.load.image('bullet-icon', 'Assets/Media/Finished/bullet-icon.png');
                this.load.image('speed-icon', 'Assets/Media/Finished/speed-icon.png');
                this.load.image('shield-icon', 'Assets/Media/Finished/shield-icon.png');
                this.load.image('freeze-icon', 'Assets/Media/Finished/freeze-icon.png');
                this.load.image('player-shield', 'Assets/Media/Finished/player-shield.png');
                this.load.spritesheet('dude', 'Assets/Media/Finished/dude.png', { frameWidth: 32, frameHeight: 48 });

                this.load.image("tiles", "Assets/Media/Finished/tileset.png");
                this.load.tilemapTiledJSON("map", "Assets/Tiles/mainTileset.json");
            }

            create ()
            {
                //Camera
                cam = this.cameras.main;
                cam.setBounds(0,0,Main.BOUNDS_X, Main.BOUNDS_Y);

                //Enviorment
                background = this.add.tileSprite(400,300,cam.width,cam.height, 'sky');
                background.setScrollFactor(0); //keeps moving with the camera

                //Tilemap
                const map = this.make.tilemap({key: 'map'});
                const tileset = map.addTilesetImage('test_tileset', 'tiles');

                //Platforms
                Setup.setUpPlatforms(this, map, tileset);

                //Ground
                this.grounds = map.createLayer("Ground", tileset, 0, 0);
                this.grounds.setCollisionByProperty({collides: true});

                //Power-ups
                this.powerUpsManager = new PowerUpsManager(this);
                this.powerUpsGroup = this.physics.add.staticGroup();
                this.powerUpsManager.spawnPowerUps(map);
                
                //Player
                this.player = new Player(this, 0, 1300, 'dude');

                //Wand
                this.wand = this.physics.add.sprite(this.player.x, this.player.y, 'wand');
                this.wand.setOrigin(0.5,1);
                this.wand.body.setAllowGravity(false);

                //Spells
                this.spellManager = new SpellManager(this);
                this.spellManager.startAutoShoot();

                this.spells = this.physics.add.group({
                    defaultKey: 'fire'
                })

                //Enemy
                // Create a group for enemies
                this.enemiesGroup = this.physics.add.group();
                //Spawn enemies in waves
                EnemyManager.scheduleNextWave(this);

                //Mouse set-up
                this.input.on('pointerdown', (pointer) => {
                    if (pointer.leftButtonDown()) {
                        this.leftMouseJustDown = true;
                    }

                    if (pointer.rightButtonDown()) {
                        this.rightMouseJustDown = true;
                    }
                }, this);

                //Physics
                this.physics.world.setBounds(0,0,Main.BOUNDS_X, Main.BOUNDS_Y);

                //Collision with platforms
                this.addColliders();
                
                //Animations
                Setup.setUpAnimations(this);

                //Keyboard keys
                cursors = Setup.setUpKeyboardControls(this);

                //Camera movement
                cam.startFollow(this.player);

                /************
                * IMPORTANT
                * 
                * The on screen UI needs to be the last one
                */

                Setup.setUpUI(this);

                this.scoreText = this.add.text(10, 10, 'Score: 0', { fontSize: '32px', fill: '#000' });
                this.scoreText.setScrollFactor(0);
            }

            update () 
            {
                //Game over
                if(this.isGameOver == true) {
                    return;
                }

                //Movement
                this.player.Movement(cursors);

                //Enemy movement
                EnemyManager.aiMovement(this, this.player);

                //Spell selection
                //Fire
                if (Phaser.Input.Keyboard.JustDown(cursors.firstSpell)) {
                    this.spellManager.addSpellToSlot(this, 'fire', 'fireUI');
                    // console.log(this.spellsStorage);
                }

                //Water
                if (Phaser.Input.Keyboard.JustDown(cursors.secondSpell)) {
                    this.spellManager.addSpellToSlot(this, 'water', 'waterUI');
                    // console.log(this.spellsStorage);
                }

                //Air
                if(this.leftMouseJustDown == true) {
                    this.spellManager.addSpellToSlot(this, 'air', 'airUI');
                    this.leftMouseJustDown = false; // Only click for 1 frame
                    // console.log(this.spellsStorage);
                }

                //Earth
                if(this.rightMouseJustDown == true) {
                    this.spellManager.addSpellToSlot(this, 'earth', 'earthUI');
                    this.rightMouseJustDown = false; // Only click for 1 frame
                    // console.log(this.spellsStorage);
                }

                //Wand sticks to player
                this.player.AttachWandToPlayerAndRotate(this);
                
                //Remove spells from world if out of bounds
                this.spellManager.removeSpellIfOutOfBounds(this, Main.BOUNDS_X, Main.BOUNDS_Y);
                
                //Background movement with the player
                background.tilePositionX = cam.scrollX;
                background.tilePositionY = cam.scrollY;
            }

            gameOver(player,enemy) {
                if(!player.isShielded) {
                    this.isGameOver = true;
                }
            }

            addColliders() {
                this.physics.add.collider(this.player, this.platforms);
                this.physics.add.collider(this.enemiesGroup, this.platforms);

                //Collision with ground
                this.physics.add.collider(this.player, this.grounds);
                //this.physics.add.collider(this.enemiesGroup, grounds);

                //Player-Enemy collision
                this.physics.add.collider(this.player,this.enemiesGroup, this.gameOver, null, this);

                //Spell-Enemy collision
                this.physics.add.collider(this.spells, this.enemiesGroup, EnemyManager.killEnemy, null, this);

                //Power-ups collision
                this.physics.add.collider(this.player, this.powerUpsGroup, this.powerUpPickup, null, this);
            }

            powerUpPickup(player, powerUp) {
                switch(powerUp.powerUpType) {
                    case 'IncreasedSpeed':
                        this.powerUpsManager.addPowerUp('IncreasedSpeed', new PowerUpEffects.IncreasedSpeed(player), 5000);
                        break;
                    case 'IncreasedFireRate':
                        this.powerUpsManager.addPowerUp('IncreasedFireRate', new PowerUpEffects.IncreasedFireRate(this.spellManager), 5000);
                        break;
                    case 'ShieldPlayer':
                        this.powerUpsManager.addPowerUp('ShieldPlayer', new PowerUpEffects.ShieldPlayer(player), 2000);
                        break;
                    case 'FreezeEnemies':
                        this.powerUpsManager.addPowerUp('FreezeEnemies', new PowerUpEffects.FreezeEnemies(this.enemiesGroup), 3000);
                        break;
                    default: 
                        break;
                }
                this.time.delayedCall( 5000, this.powerUpsManager.respawnPowerUp, [powerUp], this.powerUpsManager);
                powerUp.destroy();
            }
        }

        const config = {
            type: Phaser.AUTO,
            width: 800,
            height: 600,
            scene: Main,
            pixelArt: true,
            disableContextMenu: true, //Disable right mouse button menu
            physics: {
                default: 'arcade',
                arcade: {
                    gravity: { y: 300 },
                    debug: true
                }
            },
        };

        const game = new Phaser.Game(config);
    
    </script>

</body>
</html>