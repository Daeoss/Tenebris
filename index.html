<!DOCTYPE html>
<html>
<head>
    <script src="/Server/node_modules/phaser/dist/phaser-arcade-physics.js"></script>
    <script src="/Server/node_modules/phaser/dist/phaser.js"></script>
</head>
<body>

    <script type="module">
        //randomize enemy creation
        import Enemy from '/Scripts/Enemy.js';
        import Player from '/Scripts/Player.js';
        import * as Setup from '/Scripts/Setup.js';
        import * as EnemyManager from '/Scripts/EnemyManager.js';
        import * as SpellManager from '/Scripts/SpellManager.js';

        var platforms, cam, background, grounds,cursors;

        class Main extends Phaser.Scene
        {
            static BOUNDS_X = 2140;
            static BOUNDS_Y = 1070;

            constructor() {
                super();
                this.score = 0;
                this.player = null;
                this.enemiesGroup = null;
                this.wand = null;
                this.spells = null;
                this.scoreText = null;
                this.isGameOver = false;
                this.leftMouseJustDown = false;
                this.rightMouseJustDown = false;
                this.spellsStorage = [];
                this.spellHolders = {
                    0: {x:375,y:50}, 
                    1: {x:450,y:50},
                    // holder1: {x:325,y:50}, 
                    // holder2: {x:400,y:50},
                    // holder3: {x:475,y:50},
                };
                
            }
            preload ()
            {
                this.load.image('sky', 'Assets/Media/Finished/sky.png');
                this.load.image('ground', 'Assets/Media/Finished/platform.png');
                this.load.image('star', 'Assets/Media/Finished/star.png');
                this.load.image('bomb', 'Assets/Media/Finished/bomb.png');
                this.load.image('shadow', 'Assets/Media/Finished/Shadow.png');
                this.load.image('flying-shadow', 'Assets/Media/Finished/FlyingShadow.png');
                this.load.image('wand', 'Assets/Media/Finished/wand.png');
                this.load.image('fire', 'Assets/Media/Finished/fire.png');
                this.load.image('fireUI', 'Assets/Media/Finished/fireUI.png');
                this.load.image('waterUI', 'Assets/Media/Finished/waterUI.png');
                this.load.image('airUI', 'Assets/Media/Finished/airUI.png');
                this.load.image('earthUI', 'Assets/Media/Finished/earthUI.png');
                this.load.image('spell-holder', 'Assets/Media/Finished/spell-holder.png');
                this.load.spritesheet('dude', 'Assets/Media/Finished/dude.png', { frameWidth: 32, frameHeight: 48 });
            }

            create ()
            {
                //Camera
                cam = this.cameras.main;
                cam.setBounds(0,0,Main.BOUNDS_X, Main.BOUNDS_Y);

                //Enviorment
                background = this.add.tileSprite(400,300,cam.width,cam.height, 'sky');
                background.setScrollFactor(0); //keeps moving with the camera

                //Platforms
                platforms = Setup.setUpPlatforms(this);

                //Ground
                grounds = this.physics.add.staticGroup();
                grounds.create(1000,1070, 'ground').setScale(6,1).refreshBody();

                //Player
                this.player = new Player(this, 0, 1000, 'dude')

                //Wand
                this.wand = this.physics.add.sprite(this.player.x, this.player.y, 'wand');
                this.wand.setOrigin(0.5,1);
                this.wand.body.setAllowGravity(false);

                //Shooting spell
                this.time.addEvent({
                    delay: 1000,
                    callback: SpellManager.shootSpell,
                    callbackScope: this,
                    loop:true,
                })

                //Spells
                this.spells = this.physics.add.group({
                    defaultKey: 'fire'
                })

                //Enemy
                // Create a group for enemies
                this.enemiesGroup = this.physics.add.group();
                // Spawn enemies
                this.time.addEvent({
                    delay: 1000,
                    callback: EnemyManager.spawnEnemy,
                    callbackScope: this,
                    loop:true,
                });

                //Mouse set-up
                this.input.on('pointerdown', (pointer) => {
                    if (pointer.leftButtonDown()) {
                        this.leftMouseJustDown = true;
                    }

                    if (pointer.rightButtonDown()) {
                        this.rightMouseJustDown = true;
                    }
                }, this);

                //Physics
                this.physics.world.setBounds(0,0,Main.BOUNDS_X, Main.BOUNDS_Y);

                //Collision with platforms
                this.addColliders();
                
                //Animations
                Setup.setUpAnimations(this);

                //Keyboard keys
                cursors = Setup.setUpKeyboardControls(this);

                //Camera movement
                cam.startFollow(this.player);

                /************
                * IMPORTANT
                * 
                * The on screen UI needs to be the last one
                */

                Setup.setUpUI(this);

                this.scoreText = this.add.text(10, 10, 'Score: 0', { fontSize: '32px', fill: '#000' });
                this.scoreText.setScrollFactor(0);
            }

            update () 
            {
                //Game over
                if(this.isGameOver == true) {
                    return;
                }

                //Movement
                this.player.Movement(cursors, 160);

                //Enemy movement
                EnemyManager.aiMovement(this, this.player);

                //Spell selection
                //Fire
                if (Phaser.Input.Keyboard.JustDown(cursors.firstSpell)) {
                    SpellManager.addSpellToSlot(this, 'fire', 'fireUI');
                    console.log(this.spellsStorage);
                }

                //Water
                if (Phaser.Input.Keyboard.JustDown(cursors.secondSpell)) {
                    SpellManager.addSpellToSlot(this, 'water', 'waterUI');
                    console.log(this.spellsStorage);
                }

                //Air
                if(this.leftMouseJustDown == true) {
                    SpellManager.addSpellToSlot(this, 'air', 'airUI');
                    console.log(this.spellsStorage);
                    this.leftMouseJustDown = false;
                }

                //Earth
                if(this.rightMouseJustDown == true) {
                    SpellManager.addSpellToSlot(this, 'earth', 'earthUI');
                    console.log(this.spellsStorage);
                    this.rightMouseJustDown = false;
                }

                //Wand sticks to player
                this.player.AttachWandToPlayerAndRotate(this);
                
                //Remove spells from world if out of bounds
                SpellManager.removeSpellIfOutOfBounds(this, Main.BOUNDS_X, Main.BOUNDS_Y);
                
                //Background movement with the player
                background.tilePositionX = cam.scrollX;
                background.tilePositionY = cam.scrollY;
            }

            gameOver() {
                this.isGameOver = true;
            }

            addColliders() {
                this.physics.add.collider(this.player, platforms);
                this.physics.add.collider(this.enemiesGroup, platforms);

                //Collision with ground
                this.physics.add.collider(this.player, grounds);
                //this.physics.add.collider(this.enemiesGroup, grounds);

                //Player-Enemy collision
                this.physics.add.collider(this.player,this.enemiesGroup, this.gameOver, null, this);

                //Spell-Enemy collision
                this.physics.add.collider(this.spells, this.enemiesGroup, EnemyManager.killEnemy, null, this);
            }
        }

        const config = {
            type: Phaser.AUTO,
            width: 800,
            height: 600,
            scene: Main,
            disableContextMenu: true, //Disable right mouse button menu
            physics: {
                default: 'arcade',
                arcade: {
                    gravity: { y: 300 },
                    debug: true
                }
            },
        };

        const game = new Phaser.Game(config);
    
    </script>

</body>
</html>